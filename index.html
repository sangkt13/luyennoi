<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Speaking Pro - AI Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .recording-pulse {
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .mic-button {
            transition: all 0.3s ease;
        }
        .mic-button:active {
            transform: scale(0.95);
        }
        /* Scrollbar custom */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#10b981',
                        accent: '#f59e0b',
                    }
                }
            }
        }
    </script>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="bg-white border-b border-gray-200 shadow-sm z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center gap-2 cursor-pointer" onclick="app.goHome()">
                        <i class="fa-solid fa-microphone-lines text-primary text-2xl"></i>
                        <span class="font-bold text-xl text-gray-800 tracking-tight">IELTS Speaking Pro</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <!-- N√∫t c·∫•u h√¨nh AI thay th·∫ø v·ªã tr√≠ n√∫t ƒëƒÉng nh·∫≠p c≈© -->
                    <button onclick="app.toggleSettings()" class="flex items-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 hover:text-primary hover:border-primary transition shadow-sm">
                        <i class="fa-solid fa-gear"></i>
                        <span>C·∫•u h√¨nh AI</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-6 relative" id="main-container">
        
        <!-- View: Topic Grid (Home) -->
        <div id="topic-view" class="max-w-7xl mx-auto animate-fade-in">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">Ch·ªçn ch·ªß ƒë·ªÅ luy·ªán t·∫≠p</h1>
                <p class="text-lg text-gray-600">Luy·ªán n√≥i v√† nh·∫≠n ƒë√°nh gi√° AI ngay l·∫≠p t·ª©c.</p>
            </div>

            <!-- Search/Filter -->
            <div class="max-w-xl mx-auto mb-8 relative">
                <input type="text" id="search-input" placeholder="T√¨m ki·∫øm ch·ªß ƒë·ªÅ (Hobbies, Work, Health...)" 
                    class="w-full pl-12 pr-4 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary shadow-sm">
                <i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-400"></i>
            </div>

            <!-- Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="topic-grid">
                <!-- Topics will be injected here via JS -->
            </div>
        </div>

        <!-- View: Practice Interface -->
        <div id="practice-view" class="hidden max-w-7xl mx-auto h-full flex flex-col md:flex-row gap-6">
            <!-- Left Sidebar: Questions -->
            <div class="w-full md:w-1/3 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col overflow-hidden h-[600px] md:h-auto">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <h2 class="font-bold text-gray-800" id="current-topic-title">Topic Name</h2>
                    <button onclick="app.goHome()" class="text-sm text-gray-500 hover:text-primary">
                        <i class="fa-solid fa-arrow-left"></i> Quay l·∫°i
                    </button>
                </div>
                <div class="p-4 overflow-y-auto flex-1" id="question-list">
                    <!-- Questions injected here -->
                </div>
            </div>

            <!-- Right Area: Recording & AI -->
            <div class="w-full md:w-2/3 flex flex-col gap-6">
                
                <!-- Recording Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex-1 flex flex-col">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">C√¢u h·ªèi ƒëang ch·ªçn:</h3>
                        <p class="text-primary text-xl font-medium" id="active-question-text">H√£y ch·ªçn m·ªôt c√¢u h·ªèi b√™n tr√°i</p>
                    </div>

                    <!-- Transcript Area -->
                    <textarea id="transcript-area" 
                        class="w-full flex-1 p-4 bg-gray-50 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary mb-4 resize-none font-medium text-gray-700"
                        placeholder="N·ªôi dung b√†i n√≥i c·ªßa b·∫°n s·∫Ω hi·ªán ·ªü ƒë√¢y (ho·∫∑c g√µ tr·ª±c ti·∫øp)..." spellcheck="false"></textarea>

                    <!-- Controls -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                             <button id="btn-record" onclick="app.toggleRecording()" 
                                class="mic-button group flex items-center justify-center w-14 h-14 rounded-full bg-red-100 text-red-600 hover:bg-red-600 hover:text-white border-2 border-red-500">
                                <i class="fa-solid fa-microphone text-xl"></i>
                            </button>
                            <span class="text-sm text-gray-500" id="record-status">Nh·∫•n ƒë·ªÉ n√≥i</span>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="app.clearTranscript()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">
                                X√≥a
                            </button>
                            <button onclick="app.analyzeSpeaking()" class="px-6 py-2 bg-gradient-to-r from-primary to-indigo-600 text-white rounded-lg shadow hover:shadow-lg transition flex items-center gap-2">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> Ch·∫•m ƒëi·ªÉm AI
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI Feedback Section -->
                <div id="ai-result" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hidden">
                    <div class="flex items-center justify-between mb-4 border-b border-gray-100 pb-2">
                        <h3 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-robot text-accent mr-2"></i>ƒê√°nh gi√° c·ªßa AI</h3>
                        <span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded">IELTS Part 1</span>
                    </div>
                    <div id="ai-content" class="prose prose-sm max-w-none text-gray-700">
                        <!-- AI Output Markdown -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">C√†i ƒë·∫∑t AI</h3>
                <button onclick="app.toggleSettings()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">OpenAI / Gemini API Key</label>
                <input type="password" id="api-key-input" placeholder="sk-..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:outline-none">
                <p class="text-xs text-gray-500 mt-1">Key c·ªßa b·∫°n ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô tr√™n tr√¨nh duy·ªát.</p>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">M√¥ h√¨nh AI</label>
                <select id="ai-model-select" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Nhanh)</option>
                    <option value="gpt-4o">GPT-4o (Ch√≠nh x√°c)</option>
                </select>
            </div>
            <button onclick="app.saveSettings()" class="w-full bg-primary text-white rounded-lg py-2 font-medium hover:bg-indigo-700">L∆∞u c√†i ƒë·∫∑t</button>
        </div>
    </div>

    <script>
        // DATA SOURCE
        const topicsData = [
            {
                id: "hobbies",
                title: "Hobbies",
                icon: "fa-gamepad",
                color: "bg-pink-100 text-pink-600",
                questions: [
                    "Do you have the same hobbies as your family members?",
                    "Do you have a hobby that you've had since childhood?",
                    "Did you have any hobbies when you were a child?",
                    "Do you have any hobbies?"
                ]
            },
            {
                id: "scenery",
                title: "Scenery",
                icon: "fa-mountain-sun",
                color: "bg-green-100 text-green-600",
                questions: [
                    "Where can you enjoy beautiful views where you live?",
                    "What‚Äôs the best view that you have ever enjoyed?",
                    "Do you take photos of good views?",
                    "Do you book rooms that have good views when you go travelling?",
                    "Do you look out the window at the scenery when travelling by bus or car?",
                    "Do you prefer the mountains or the sea?"
                ]
            },
            {
                id: "health",
                title: "Health",
                icon: "fa-heart-pulse",
                color: "bg-red-100 text-red-600",
                questions: [
                    "How do you keep healthy?",
                    "What are your favorite sports?",
                    "Are there health classes in your school?",
                    "What sports help people stay healthy?",
                    "Is it easy for people to exercise in your country?",
                    "Did you learn how to live a healthy lifestyle when you were a child?"
                ]
            },
            {
                id: "work_study",
                title: "Work or Studies",
                icon: "fa-briefcase",
                color: "bg-blue-100 text-blue-600",
                questions: [
                    "Are you a student or do you work now?",
                    "What would you like to do in the future?",
                    "What do you think is the most important at the moment?",
                    "Why did you choose to do that type of work?",
                    "Do you like your job?",
                    "Do you prefer to work in the morning or the afternoon?"
                ]
            },
            {
                id: "photos",
                title: "Taking Photos",
                icon: "fa-camera",
                color: "bg-purple-100 text-purple-600",
                questions: [
                    "Do you take photos by camera or phone?",
                    "How do you deal with pictures after you take them?",
                    "Do you want to learn photography to improve your taking-photo skills?",
                    "Is it good to keep photos on a cell phone?",
                    "Do you like taking photos of yourself?"
                ]
            },
            {
                id: "area",
                title: "The area you live in",
                icon: "fa-map-location-dot",
                color: "bg-yellow-100 text-yellow-600",
                questions: [
                    "Do you like the area that you live in?",
                    "Where do you like to go in that area?",
                    "Do you know any of your neighbors?",
                    "Are there any things you don't like about your area?",
                    "Do you like living in the countryside?"
                ]
            },
            {
                id: "morning",
                title: "Morning Time",
                icon: "fa-sun",
                color: "bg-orange-100 text-orange-600",
                questions: [
                    "Do you get up early in the morning?",
                    "Do you have the same morning routine every day?",
                    "Do you usually eat breakfast at home?",
                    "What do you usually do in the morning?"
                ]
            },
            {
                id: "gifts",
                title: "Gifts",
                icon: "fa-gift",
                color: "bg-rose-100 text-rose-600",
                questions: [
                    "Have you ever sent handmade gifts to others?",
                    "How to choose a gift?",
                    "Do you like giving gifts/presents?",
                    "When do you usually give gifts to others?",
                    "What gift have you received recently?"
                ]
            },
            {
                id: "reading",
                title: "Reading",
                icon: "fa-book-open",
                color: "bg-indigo-100 text-indigo-600",
                questions: [
                    "Which do you prefer, reading books or watching movies?",
                    "Are your reading habits now different than before?",
                    "Do you often read books? When?",
                    "Do you prefer to read on paper or on a screen?"
                ]
            },
            {
                id: "pets",
                title: "Pets",
                icon: "fa-paw",
                color: "bg-stone-100 text-stone-600",
                questions: [
                    "Do you keep a pet?",
                    "Did you have any pets when you were a child?",
                    "What's your favorite animal? Why?",
                    "Where do you prefer to keep your pet, indoors or outdoors?"
                ]
            },
             {
                id: "typing",
                title: "Typing",
                icon: "fa-keyboard",
                color: "bg-gray-100 text-gray-600",
                questions: [
                    "Do you prefer typing or handwriting?",
                    "Do you type on a desktop or laptop keyboard every day?",
                    "When did you learn how to type on a keyboard?",
                    "How do you improve your typing?"
                ]
            },
            {
                id: "arts",
                title: "Arts and Drawing",
                icon: "fa-palette",
                color: "bg-teal-100 text-teal-600",
                questions: [
                    "Do you like art?",
                    "Do you like visiting art galleries?",
                    "Do you like drawing? Why?",
                    "Did you learn to draw or paint when you were younger?"
                ]
            }
        ];

        // APP LOGIC
        const app = {
            currentTopic: null,
            currentQuestion: null,
            isRecording: false,
            recognition: null,
            apiKey: localStorage.getItem('openai_key') || '',

            init() {
                this.renderTopics(topicsData);
                this.setupSpeechRecognition();
                
                // Load saved key to input
                if(this.apiKey) document.getElementById('api-key-input').value = this.apiKey;

                // Search listener
                document.getElementById('search-input').addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = topicsData.filter(t => t.title.toLowerCase().includes(term));
                    this.renderTopics(filtered);
                });
            },

            renderTopics(data) {
                const grid = document.getElementById('topic-grid');
                grid.innerHTML = data.map(topic => 
                    <div onclick="app.openTopic('${topic.id}')" 
                        class="bg-white rounded-xl shadow hover:shadow-lg hover:-translate-y-1 transition-all duration-300 cursor-pointer overflow-hidden border border-gray-100 group">
                        <div class="p-6">
                            <div class="${topic.color} w-14 h-14 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                <i class="fa-solid ${topic.icon} text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${topic.title}</h3>
                            <p class="text-sm text-gray-500">${topic.questions.length} Questions</p>
                        </div>
                        <div class="bg-gray-50 px-6 py-3 border-t border-gray-100 flex justify-between items-center">
                            <span class="text-xs font-semibold text-primary">Luy·ªán t·∫≠p ngay</span>
                            <i class="fa-solid fa-arrow-right text-gray-400 group-hover:text-primary transition"></i>
                        </div>
                    </div>
                ).join('');
            },

            openTopic(id) {
                this.currentTopic = topicsData.find(t => t.id === id);
                if (!this.currentTopic) return;

                document.getElementById('topic-view').classList.add('hidden');
                document.getElementById('practice-view').classList.remove('hidden');
                document.getElementById('practice-view').classList.add('flex');
                
                document.getElementById('current-topic-title').innerText = this.currentTopic.title;
                
                // Render Questions
                const list = document.getElementById('question-list');
                list.innerHTML = this.currentTopic.questions.map((q, index) => 
                    <div onclick="app.selectQuestion(${index})" 
                        class="question-item p-3 mb-2 rounded-lg cursor-pointer transition hover:bg-indigo-50 border border-transparent hover:border-indigo-100 text-gray-700 text-sm">
                        ${index + 1}. ${q}
                    </div>
                ).join('');

                // Reset state
                this.selectQuestion(0);
                this.clearTranscript();
                document.getElementById('ai-result').classList.add('hidden');
            },

            selectQuestion(index) {
                // UI Highlight
                const items = document.querySelectorAll('.question-item');
                items.forEach(el => el.classList.remove('bg-indigo-100', 'border-indigo-200', 'font-medium', 'text-primary'));
                items[index].classList.add('bg-indigo-100', 'border-indigo-200', 'font-medium', 'text-primary');

                this.currentQuestion = this.currentTopic.questions[index];
                document.getElementById('active-question-text').innerText = this.currentQuestion;
            },

            goHome() {
                document.getElementById('practice-view').classList.add('hidden');
                document.getElementById('practice-view').classList.remove('flex');
                document.getElementById('topic-view').classList.remove('hidden');
                this.stopRecording();
            },

            setupSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'en-US';

                    this.recognition.onresult = (event) => {
                        let finalTranscript = '';
                        for (let i = event.resultIndex; i < event.results.length; ++i) {
                            if (event.results[i].isFinal) {
                                finalTranscript += event.results[i][0].transcript;
                            }
                        }
                        if (finalTranscript) {
                            const area = document.getElementById('transcript-area');
                            area.value += (area.value ? ' ' : '') + finalTranscript;
                            area.scrollTop = area.scrollHeight;
                        }
                    };

                    this.recognition.onerror = (event) => {
                        console.error('Speech error:', event.error);
                        this.stopRecording();
                    };
                } else {
                    alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i. H√£y d√πng Google Chrome.");
                    document.getElementById('btn-record').disabled = true;
                }
            },

            toggleRecording() {
                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    this.startRecording();
                }
            },

            startRecording() {
                if (!this.recognition) return;
                this.isRecording = true;
                this.recognition.start();
                
                const btn = document.getElementById('btn-record');
                btn.classList.add('recording-pulse', 'bg-red-600', 'text-white');
                document.getElementById('record-status').innerText = "ƒêang ghi √¢m...";
            },

            stopRecording() {
                if (!this.recognition) return;
                this.isRecording = false;
                this.recognition.stop();

                const btn = document.getElementById('btn-record');
                btn.classList.remove('recording-pulse', 'bg-red-600', 'text-white');
                document.getElementById('record-status').innerText = "Nh·∫•n ƒë·ªÉ n√≥i";
            },

            clearTranscript() {
                document.getElementById('transcript-area').value = '';
                document.getElementById('ai-result').classList.add('hidden');
            },

            toggleSettings() {
                const modal = document.getElementById('settings-modal');
                if (modal.classList.contains('hidden')) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                } else {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            },

            saveSettings() {
                const key = document.getElementById('api-key-input').value.trim();
                if (key) {
                    localStorage.setItem('openai_key', key);
                    this.apiKey = key;
                    alert("ƒê√£ l∆∞u API Key th√†nh c√¥ng!");
                }
                this.toggleSettings();
            },

            async analyzeSpeaking() {
                const transcript = document.getElementById('transcript-area').value;
                const aiBox = document.getElementById('ai-result');
                const aiContent = document.getElementById('ai-content');

                if (!transcript.trim()) {
                    alert("Vui l√≤ng ghi √¢m ho·∫∑c nh·∫≠p c√¢u tr·∫£ l·ªùi tr∆∞·ªõc khi ch·∫•m ƒëi·ªÉm.");
                    return;
                }

                aiBox.classList.remove('hidden');
                aiContent.innerHTML = '<div class="flex items-center gap-2"><i class="fa-solid fa-spinner fa-spin"></i> ƒêang ph√¢n t√≠ch c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n...</div>';

                // MOCK RESPONSE IF NO KEY (For Demo/Vercel preview without key)
                if (!this.apiKey) {
                    setTimeout(() => {
                        const mockResponse = 
**L∆∞u √Ω:** ƒê√¢y l√† k·∫øt qu·∫£ m√¥ ph·ªèng v√¨ ch∆∞a c√≥ API Key.

### ƒêi·ªÉm ∆∞·ªõc l∆∞·ª£ng: 6.5

**Grammar:**
- B·∫°n s·ª≠ d·ª•ng c√°c c√¢u ƒë∆°n kh√° t·ªët.
- *G·ª£i √Ω:* H√£y th·ª≠ d√πng th√™m c√°c t·ª´ n·ªëi nh∆∞ "However", "Furthermore" ƒë·ªÉ c√¢u ph·ª©c t·∫°p h∆°n.

**Vocabulary:**
- T·ª´ v·ª±ng thu·ªôc ch·ªß ƒë·ªÅ ${this.currentTopic.title} kh√° ·ªïn.
- *G·ª£i √Ω n√¢ng cao:* Thay v√¨ d√πng "good", h√£y d√πng "spectacular" ho·∫∑c "breathtaking".

**Pronunciation:**
- C·∫ßn ch√∫ √Ω √¢m ƒëu√¥i (ending sounds) r√µ h∆°n.
                        ;
                        aiContent.innerHTML = marked.parse(mockResponse);
                        alert("Vui l√≤ng nh·∫≠p API Key trong ph·∫ßn C√†i ƒë·∫∑t ƒë·ªÉ s·ª≠ d·ª•ng AI th·∫≠t.");
                    }, 1500);
                    return;
                }

                // REAL API CALL (Logic for when key is added)
                try {
                    const prompt = 
                    Act as an IELTS Examiner. 
                    Topic: ${this.currentTopic.title}
                    Question: "${this.currentQuestion}"
                    Student Answer: "${transcript}"
                    
                    Please provide feedback in Vietnamese:
                    1. Estimated Band Score (0-9)
                    2. Corrections for Grammar & Vocabulary errors.
                    3. Better version of the answer (Paraphrase).
                    Format with Markdown.
                    ;

                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': Bearer ${this.apiKey}
                        },
                        body: JSON.stringify({
                            model: document.getElementById('ai-model-select').value,
                            messages: [{ role: "user", content: prompt }],
                            temperature: 0.7
                        })
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    
                    aiContent.innerHTML = marked.parse(data.choices[0].message.content);

                } catch (error) {
                    aiContent.innerHTML = <div class="text-red-500">L·ªói k·∫øt n·ªëi AI: ${error.message}. Ki·ªÉm tra l·∫°i API Key.</div>;
                }
            }
        };

        // Start App
        window.onload = () => app.init();

    </script>
</body>
</html>

ChatGPT ƒë√£ n√≥i:
D∆∞·ªõi ƒë√¢y l√† b·∫£n ch·ªânh s·ª≠a ƒë·ªÉ b·∫°n d√πng ƒë∆∞·ª£c c·∫£ OpenAI (ChatGPT) v√† Google Gemini trong c√πng 1 file HTML.

‚úÖ ƒêi·ªÉm quan tr·ªçng l√†m Gemini ‚Äúkh√¥ng ch·∫°y‚Äù trong code c·ªßa b·∫°n:

B·∫°n ƒëang g·ªçi OpenAI endpoint (https://api.openai.com/v1/chat/completions) cho m·ªçi key ‚Üí Gemini key ch·∫Øc ch·∫Øn l·ªói.

Gemini API d√πng endpoint kh√°c v√† model name kh√°c (v√≠ d·ª•: gemini-1.5-flash, gemini-1.5-pro‚Ä¶), v√† payload c≈©ng kh√°c.

1) Thay ƒë·ªïi UI: th√™m ch·ªçn ‚ÄúNh√† cung c·∫•p AI‚Äù
Trong ph·∫ßn Settings Modal, th√™m dropdown ch·ªçn Provider (OpenAI/Gemini) v√† model t∆∞∆°ng ·ª©ng.

üëâ B·∫°n ch·ªâ c·∫ßn thay ƒëo·∫°n Settings Modal c·ªßa b·∫°n b·∫±ng ƒëo·∫°n d∆∞·ªõi (ho·∫∑c s·ª≠a ƒë√∫ng c√°c ph·∫ßn t∆∞∆°ng ·ª©ng):

<!-- Settings Modal -->
<div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold">C√†i ƒë·∫∑t AI</h3>
      <button onclick="app.toggleSettings()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
    </div>

    <!-- Provider -->
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Nh√† cung c·∫•p AI</label>
      <select id="ai-provider-select" class="w-full border border-gray-300 rounded-lg px-3 py-2" onchange="app.onProviderChange()">
        <option value="openai">OpenAI (ChatGPT)</option>
        <option value="gemini">Google Gemini</option>
      </select>
      <p class="text-xs text-gray-500 mt-1">Ch·ªçn OpenAI ho·∫∑c Gemini ƒë·ªÉ g·ªçi ƒë√∫ng API.</p>
    </div>

    <!-- API Key -->
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
      <input type="password" id="api-key-input" placeholder="sk-... ho·∫∑c AIza..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:outline-none">
      <p class="text-xs text-gray-500 mt-1">Key c·ªßa b·∫°n ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô tr√™n tr√¨nh duy·ªát.</p>
    </div>

    <!-- Model -->
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">M√¥ h√¨nh AI</label>

      <!-- OpenAI models -->
      <select id="openai-model-select" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        <option value="gpt-4o-mini">GPT-4o mini (Nhanh/ti·∫øt ki·ªám)</option>
        <option value="gpt-4o">GPT-4o (Ch√≠nh x√°c)</option>
      </select>

      <!-- Gemini models -->
      <select id="gemini-model-select" class="w-full border border-gray-300 rounded-lg px-3 py-2 hidden">
        <option value="gemini-1.5-flash">Gemini 1.5 Flash (Nhanh)</option>
        <option value="gemini-1.5-pro">Gemini 1.5 Pro (Ch√≠nh x√°c)</option>
      </select>
    </div>

    <button onclick="app.saveSettings()" class="w-full bg-primary text-white rounded-lg py-2 font-medium hover:bg-indigo-700">
      L∆∞u c√†i ƒë·∫∑t
    </button>
  </div>
</div>
2) Thay ƒë·ªïi JS: l∆∞u provider + g·ªçi ƒë√∫ng API
üëâ B·∫°n ch·ªâ c·∫ßn thay ph·∫ßn APP LOGIC (const app = { ... }) b·∫±ng b·∫£n d∆∞·ªõi (m√¨nh gi·ªØ nguy√™n c√°c h√†m kh√°c c·ªßa b·∫°n, ch·ªâ b·ªï sung/ch·ªânh c√°c ph·∫ßn li√™n quan AI):

L∆∞u √Ω: ƒë√¢y l√† ‚Äúdrop-in replacement‚Äù cho object app c·ªßa b·∫°n. B·∫°n copy ƒë√® l√™n const app = { ... } hi·ªán t·∫°i.

<script>
  // APP LOGIC
  const app = {
    currentTopic: null,
    currentQuestion: null,
    isRecording: false,
    recognition: null,

    // Settings
    provider: localStorage.getItem('ai_provider') || 'openai',
    apiKey: localStorage.getItem('ai_key') || '',
    openaiModel: localStorage.getItem('openai_model') || 'gpt-4o-mini',
    geminiModel: localStorage.getItem('gemini_model') || 'gemini-1.5-flash',

    init() {
      this.renderTopics(topicsData);
      this.setupSpeechRecognition();

      // Load saved settings to UI
      document.getElementById('ai-provider-select').value = this.provider;
      document.getElementById('api-key-input').value = this.apiKey;

      document.getElementById('openai-model-select').value = this.openaiModel;
      document.getElementById('gemini-model-select').value = this.geminiModel;

      this.onProviderChange();

      // Search listener
      document.getElementById('search-input').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = topicsData.filter(t => t.title.toLowerCase().includes(term));
        this.renderTopics(filtered);
      });
    },

    onProviderChange() {
      const provider = document.getElementById('ai-provider-select').value;
      const openaiSel = document.getElementById('openai-model-select');
      const geminiSel = document.getElementById('gemini-model-select');

      if (provider === 'openai') {
        openaiSel.classList.remove('hidden');
        geminiSel.classList.add('hidden');
      } else {
        geminiSel.classList.remove('hidden');
        openaiSel.classList.add('hidden');
      }
    },

    saveSettings() {
      const provider = document.getElementById('ai-provider-select').value;
      const key = document.getElementById('api-key-input').value.trim();
      const openaiModel = document.getElementById('openai-model-select').value;
      const geminiModel = document.getElementById('gemini-model-select').value;

      this.provider = provider;
      this.apiKey = key;
      this.openaiModel = openaiModel;
      this.geminiModel = geminiModel;

      localStorage.setItem('ai_provider', provider);
      localStorage.setItem('ai_key', key);
      localStorage.setItem('openai_model', openaiModel);
      localStorage.setItem('gemini_model', geminiModel);

      alert("ƒê√£ l∆∞u c√†i ƒë·∫∑t AI!");
      this.toggleSettings();
    },

    // ======= UI / NAV (gi·ªØ t·ª´ code b·∫°n) =======
    renderTopics(data) {
      const grid = document.getElementById('topic-grid');
      grid.innerHTML = data.map(topic => `
        <div onclick="app.openTopic('${topic.id}')"
          class="bg-white rounded-xl shadow hover:shadow-lg hover:-translate-y-1 transition-all duration-300 cursor-pointer overflow-hidden border border-gray-100 group">
          <div class="p-6">
            <div class="${topic.color} w-14 h-14 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
              <i class="fa-solid ${topic.icon} text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">${topic.title}</h3>
            <p class="text-sm text-gray-500">${topic.questions.length} Questions</p>
          </div>
          <div class="bg-gray-50 px-6 py-3 border-t border-gray-100 flex justify-between items-center">
            <span class="text-xs font-semibold text-primary">Luy·ªán t·∫≠p ngay</span>
            <i class="fa-solid fa-arrow-right text-gray-400 group-hover:text-primary transition"></i>
          </div>
        </div>
      `).join('');
    },

    openTopic(id) {
      this.currentTopic = topicsData.find(t => t.id === id);
      if (!this.currentTopic) return;

      document.getElementById('topic-view').classList.add('hidden');
      document.getElementById('practice-view').classList.remove('hidden');
      document.getElementById('practice-view').classList.add('flex');

      document.getElementById('current-topic-title').innerText = this.currentTopic.title;

      const list = document.getElementById('question-list');
      list.innerHTML = this.currentTopic.questions.map((q, index) => `
        <div onclick="app.selectQuestion(${index})"
          class="question-item p-3 mb-2 rounded-lg cursor-pointer transition hover:bg-indigo-50 border border-transparent hover:border-indigo-100 text-gray-700 text-sm">
          ${index + 1}. ${q}
        </div>
      `).join('');

      this.selectQuestion(0);
      this.clearTranscript();
      document.getElementById('ai-result').classList.add('hidden');
    },

    selectQuestion(index) {
      const items = document.querySelectorAll('.question-item');
      items.forEach(el => el.classList.remove('bg-indigo-100', 'border-indigo-200', 'font-medium', 'text-primary'));
      items[index].classList.add('bg-indigo-100', 'border-indigo-200', 'font-medium', 'text-primary');

      this.currentQuestion = this.currentTopic.questions[index];
      document.getElementById('active-question-text').innerText = this.currentQuestion;
    },

    goHome() {
      document.getElementById('practice-view').classList.add('hidden');
      document.getElementById('practice-view').classList.remove('flex');
      document.getElementById('topic-view').classList.remove('hidden');
      this.stopRecording();
    },

    toggleSettings() {
      const modal = document.getElementById('settings-modal');
      if (modal.classList.contains('hidden')) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      } else {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    },

    setupSpeechRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        this.recognition = new SpeechRecognition();
        this.recognition.continuous = true;
        this.recognition.interimResults = true;
        this.recognition.lang = 'en-US';

        this.recognition.onresult = (event) => {
          let finalTranscript = '';
          for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
              finalTranscript += event.results[i][0].transcript;
            }
          }
          if (finalTranscript) {
            const area = document.getElementById('transcript-area');
            area.value += (area.value ? ' ' : '') + finalTranscript;
            area.scrollTop = area.scrollHeight;
          }
        };

        this.recognition.onerror = (event) => {
          console.error('Speech error:', event.error);
          this.stopRecording();
        };
      } else {
        alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i. H√£y d√πng Google Chrome.");
        document.getElementById('btn-record').disabled = true;
      }
    },

    toggleRecording() {
      if (this.isRecording) this.stopRecording();
      else this.startRecording();
    },

    startRecording() {
      if (!this.recognition) return;
      this.isRecording = true;
      this.recognition.start();

      const btn = document.getElementById('btn-record');
      btn.classList.add('recording-pulse', 'bg-red-600', 'text-white');
      document.getElementById('record-status').innerText = "ƒêang ghi √¢m...";
    },

    stopRecording() {
      if (!this.recognition) return;
      this.isRecording = false;
      this.recognition.stop();

      const btn = document.getElementById('btn-record');
      btn.classList.remove('recording-pulse', 'bg-red-600', 'text-white');
      document.getElementById('record-status').innerText = "Nh·∫•n ƒë·ªÉ n√≥i";
    },

    clearTranscript() {
      document.getElementById('transcript-area').value = '';
      document.getElementById('ai-result').classList.add('hidden');
    },

    // ======= AI HELPERS =======
    buildPrompt(transcript) {
      return `
Act as an IELTS Speaking Examiner.

Topic: ${this.currentTopic?.title || "Unknown"}
Question: "${this.currentQuestion || "Unknown"}"
Student Answer: "${transcript}"

Please provide feedback in Vietnamese:
1. Estimated Band Score (0-9)
2. Corrections for Grammar & Vocabulary errors (show original -> corrected)
3. Better version of the answer (paraphrase, natural, band 7+)
4. 5 vocabulary upgrades + collocations relevant to the topic
Format with Markdown.
`.trim();
    },

    async callOpenAI(prompt) {
      const model = this.openaiModel;

      // Newer OpenAI Responses API (recommended)
      const resp = await fetch('https://api.openai.com/v1/responses', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.apiKey}`
        },
        body: JSON.stringify({
          model,
          input: prompt,
          temperature: 0.7
        })
      });

      const data = await resp.json();
      if (!resp.ok) {
        const msg = data?.error?.message || `OpenAI error (${resp.status})`;
        throw new Error(msg);
      }

      // Extract text safely
      const text =
        data.output_text ||
        (data.output && data.output[0] && data.output[0].content && data.output[0].content[0] && data.output[0].content[0].text) ||
        '';

      if (!text) throw new Error("OpenAI tr·∫£ v·ªÅ r·ªóng.");
      return text;
    },

    async callGemini(prompt) {
      const model = this.geminiModel;

      // Gemini Generative Language API
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent?key=${encodeURIComponent(this.apiKey)}`;

      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [
            { role: "user", parts: [{ text: prompt }] }
          ],
          generationConfig: {
            temperature: 0.7
          }
        })
      });

      const data = await resp.json();
      if (!resp.ok) {
        const msg = data?.error?.message || `Gemini error (${resp.status})`;
        throw new Error(msg);
      }

      const text = data?.candidates?.[0]?.content?.parts?.map(p => p.text).join('') || '';
      if (!text) throw new Error("Gemini tr·∫£ v·ªÅ r·ªóng.");
      return text;
    },

    // ======= MAIN ANALYZE =======
    async analyzeSpeaking() {
      const transcript = document.getElementById('transcript-area').value;
      const aiBox = document.getElementById('ai-result');
      const aiContent = document.getElementById('ai-content');

      if (!transcript.trim()) {
        alert("Vui l√≤ng ghi √¢m ho·∫∑c nh·∫≠p c√¢u tr·∫£ l·ªùi tr∆∞·ªõc khi ch·∫•m ƒëi·ªÉm.");
        return;
      }

      aiBox.classList.remove('hidden');
      aiContent.innerHTML = '<div class="flex items-center gap-2"><i class="fa-solid fa-spinner fa-spin"></i> ƒêang ph√¢n t√≠ch c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n...</div>';

      // Demo mode if no key
      if (!this.apiKey) {
        setTimeout(() => {
          const mockResponse = `
**L∆∞u √Ω:** ƒê√¢y l√† k·∫øt qu·∫£ m√¥ ph·ªèng v√¨ ch∆∞a c√≥ API Key.

### ƒêi·ªÉm ∆∞·ªõc l∆∞·ª£ng: 6.5

**Grammar**
- C√¢u kh√° r√µ √Ω, nh∆∞ng n√™n tƒÉng c√¢u ph·ª©c.
- G·ª£i √Ω: th√™m "However / Moreover / As a result".

**Vocabulary**
- T·ª´ v·ª±ng ·ªïn theo ch·ªß ƒë·ªÅ ${this.currentTopic?.title || ""}.
- G·ª£i √Ω n√¢ng cao: thay "good" ‚Üí "impressive / remarkable".

**Pronunciation**
- Ch√∫ √Ω ending sounds v√† nh·∫•n tr·ªçng √¢m t·ª´ kh√≥a.
`;
          aiContent.innerHTML = marked.parse(mockResponse);
          alert("H√£y nh·∫≠p API Key trong C√†i ƒë·∫∑t ƒë·ªÉ d√πng AI th·∫≠t.");
        }, 900);
        return;
      }

      try {
        const prompt = this.buildPrompt(transcript);

        let outputText = '';
        if (this.provider === 'gemini') {
          outputText = await this.callGemini(prompt);
        } else {
          outputText = await this.callOpenAI(prompt);
        }

        aiContent.innerHTML = marked.parse(outputText);

      } catch (error) {
        aiContent.innerHTML = `<div class="text-red-500 font-medium">L·ªói AI: ${String(error.message || error)}</div>
        <div class="text-xs text-gray-500 mt-2">
          G·ª£i √Ω: ki·ªÉm tra Provider ƒë√∫ng ch∆∞a (OpenAI/Gemini), model c√≥ t·ªìn t·∫°i kh√¥ng, v√† API key c√≤n hi·ªáu l·ª±c.
        </div>`;
      }
    }
  };

  window.onload = () => app.init();
</script>
3) V√¨ sao Gemini c·ªßa b·∫°n hay l·ªói ‚Äúmodel not found‚Äù?
N·∫øu b·∫°n g·∫∑p l·∫°i l·ªói ki·ªÉu:
models/gemini-1.5-flash is not found for API version v1beta...
th√¨ th∆∞·ªùng do:

b·∫°n ƒëang g·ªçi sai endpoint (ƒë√£ s·ª≠a ·ªü tr√™n),

ho·∫∑c key Gemini c·ªßa b·∫°n kh√¥ng ƒë∆∞·ª£c c·∫•p quy·ªÅn / region,

ho·∫∑c model name sai (ƒë·ªïi qua gemini-1.5-pro ho·∫∑c ki·ªÉm tra model list trong Google AI Studio).

4) L∆∞u √Ω quan tr·ªçng (ƒë·ªÉ kh·ªèi ‚Äúl·ªô key‚Äù)
B·∫°n ƒëang l∆∞u key ·ªü localStorage ‚Üí ai m·ªü m√°y b·∫°n c≈©ng l·∫•y ƒë∆∞·ª£c key.
N·∫øu b·∫°n deploy public tr√™n Vercel/GitHub Pages: kh√¥ng n√™n nh√∫ng key ·ªü client. Gi·∫£i ph√°p ƒë√∫ng l√† t·∫°o serverless function (Vercel) l√†m proxy.

N·∫øu b·∫°n mu·ªën, m√¨nh c√≥ th·ªÉ ƒë∆∞a lu√¥n b·∫£n Vercel serverless (api/openai.js + api/gemini.js) ƒë·ªÉ key n·∫±m an to√†n trong Environment Variables.


B·∫°n ƒë√£ n√≥i:
t√¥i mu·ªën hi·ªán ra c√°c ch·∫ø ƒë·ªô ai m·ªõi nh·∫•t c·ªß gemini nh∆∞ 3 pro v√† chatgpt  th√¨ ƒë√£ t·ªõi 5.2

ChatGPT ƒë√£ n√≥i:

ƒê√£ suy nghƒ© trong 7s
ƒê∆∞·ª£c. Hi·ªán t·∫°i Gemini ƒë√£ c√≥ ‚ÄúGemini 3 Pro‚Äù (v√† 3 Flash), c√≤n ph√≠a OpenAI ƒë·ªùi m·ªõi l√† GPT-5.2 (trong ChatGPT c√≥ c√°c bi·∫øn th·ªÉ nh∆∞ Instant / Thinking / Pro). 

V·∫•n ƒë·ªÅ l√†: model hi·ªÉn th·ªã trong UI ‚â† model id d√πng cho API. M√¨nh g·ª£i √Ω b·∫°n l√†m UI theo 2 l·ªõp:

T√™n th√¢n thi·ªán (Gemini 3 Pro / GPT-5.2 Thinking‚Ä¶)

Model ID th·∫≠t ƒë·ªÉ g·ªçi API.

D∆∞·ªõi ƒë√¢y l√† ph·∫ßn b·∫°n c·∫ßn thay trong code c·ªßa b·∫°n ƒë·ªÉ hi·ªán ‚ÄúGemini 3 Pro‚Äù v√† ‚ÄúGPT-5.2‚Äù v√† g·ªçi ƒë√∫ng API.

1) C·∫≠p nh·∫≠t ph·∫ßn ‚ÄúM√¥ h√¨nh AI‚Äù trong Settings (HTML)
Thay dropdown model c≈© b·∫±ng 2 dropdown (OpenAI/Gemini) nh∆∞ m√¨nh ƒë∆∞a tr∆∞·ªõc, nh∆∞ng c·∫≠p nh·∫≠t option ‚Äúm·ªõi nh·∫•t‚Äù:

<!-- Provider -->
<select id="ai-provider-select" class="w-full border border-gray-300 rounded-lg px-3 py-2" onchange="app.onProviderChange()">
  <option value="openai">OpenAI (ChatGPT)</option>
  <option value="gemini">Google Gemini</option>
</select>

<!-- OpenAI models -->
<select id="openai-model-select" class="w-full border border-gray-300 rounded-lg px-3 py-2">
  <option value="gpt-5.2">GPT-5.2 (Base)</option>
  <option value="gpt-5.2-thinking">GPT-5.2 Thinking</option>
  <option value="gpt-5.2-pro">GPT-5.2 Pro</option>
</select>

<!-- Gemini models -->
<select id="gemini-model-select" class="w-full border border-gray-300 rounded-lg px-3 py-2 hidden">
  <option value="gemini-3-pro">Gemini 3 Pro</option>
  <option value="gemini-3-flash">Gemini 3 Flash</option>
</select>
L∆∞u √Ω: Google docs th∆∞·ªùng ghi ‚ÄúGemini 3 Pro‚Äù nh∆∞ng model-id ƒë·ªÉ g·ªçi API c√≥ th·ªÉ l√† d·∫°ng gemini-3-pro (t√πy h·ªá sinh th√°i: Gemini API / Vertex AI). B·∫°n n√™n b√°m theo trang ‚ÄúGemini models‚Äù c·ªßa Google AI for Developers khi map model-id. 

2) C·∫≠p nh·∫≠t ch·ªó g·ªçi Gemini: d√πng ƒë√∫ng endpoint + ƒë√∫ng model-id
N·∫øu b·∫°n d√πng Gemini API (Google AI for Developers), endpoint chu·∫©n l√† d·∫°ng generativelanguage.googleapis.com/.../models/{model}:generateContent. 

üëâ Thay h√†m callGemini() c·ªßa b·∫°n b·∫±ng b·∫£n an to√†n h∆°n (t·ª± map model id ‚Äú3 pro/3 flash‚Äù):

getGeminiModelId() {
  // UI value -> API model id
  const v = this.geminiModel;
  if (v === 'gemini-3-pro') return 'gemini-3-pro';
  if (v === 'gemini-3-flash') return 'gemini-3-flash';
  // fallback
  return 'gemini-3-pro';
},

async callGemini(prompt) {
  const modelId = this.getGeminiModelId();

  const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(modelId)}:generateContent?key=${encodeURIComponent(this.apiKey)}`;

  const resp = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{ role: "user", parts: [{ text: prompt }] }],
      generationConfig: { temperature: 0.7 }
    })
  });

  const data = await resp.json();
  if (!resp.ok) throw new Error(data?.error?.message || `Gemini error (${resp.status})`);

  const text = data?.candidates?.[0]?.content?.parts?.map(p => p.text).join('') || '';
  if (!text) throw new Error("Gemini tr·∫£ v·ªÅ r·ªóng.");
  return text;
}
3) C·∫≠p nh·∫≠t OpenAI: GPT-5.2 d√πng Responses API (ƒë√∫ng ƒë·ªùi m·ªõi)
OpenAI khuy·∫øn ngh·ªã d√πng Responses API thay cho Chat Completions cho d·ª± √°n m·ªõi. 

V√† GPT-5.2 c√≥ trang model docs ri√™ng. 

üëâ H√£y ƒë·ªÉ callOpenAI() theo Responses API nh∆∞ b·∫°n ƒëang l√†m (b·∫£n tr∆∞·ªõc m√¨nh ƒë∆∞a l√† ƒë√∫ng h∆∞·ªõng). Ch·ªâ c·∫ßn ƒë·∫£m b·∫£o model id b·∫°n ch·ªçn l√† gpt-5.2 ho·∫∑c gpt-5.2-thinking/gpt-5.2-pro (n·∫øu t√†i kho·∫£n b·∫°n ƒë∆∞·ª£c c·∫•p).

V√≠ d·ª•:

async callOpenAI(prompt) {
  const model = this.openaiModel; // gpt-5.2 / gpt-5.2-thinking / gpt-5.2-pro

  const resp = await fetch('https://api.openai.com/v1/responses', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${this.apiKey}`
    },
    body: JSON.stringify({
      model,
      input: prompt,
      temperature: 0.7
    })
  });

  const data = await resp.json();
  if (!resp.ok) throw new Error(data?.error?.message || `OpenAI error (${resp.status})`);

  const text = data.output_text || '';
  if (!text) throw new Error("OpenAI tr·∫£ v·ªÅ r·ªóng.");
  return text;
}
4) V√¨ sao b·∫°n ‚Äúkh√¥ng th·∫•y model m·ªõi nh·∫•t‚Äù ho·∫∑c ch·ªçn l√† l·ªói?
2 nguy√™n nh√¢n hay g·∫∑p nh·∫•t:

B·∫°n hi·ªÉn th·ªã t√™n model m·ªõi nh∆∞ng key ch∆∞a c√≥ quy·ªÅn d√πng model ƒë√≥ ‚Üí API b√°o 403/404 (ƒë·∫∑c bi·ªát v·ªõi Pro/Thinking). (OpenAI: xem docs model; Google: t√πy key/quy·ªÅn/plan). 

B·∫°n d√πng sai model-id (v√≠ d·ª• ghi ‚ÄúGemini 3 Pro‚Äù nh∆∞ng g·ªçi gemini-3-pro/gemini-1.5-pro l·∫´n l·ªôn).

N·∫øu b·∫°n mu·ªën m√¨nh l√†m ‚Äúchu·∫©n nh·∫•t‚Äù: m√¨nh s·∫Ω vi·∫øt th√™m 1 n√∫t ‚ÄúKi·ªÉm tra key‚Äù ƒë·ªÉ:

OpenAI: g·ªçi endpoint models/docs t∆∞∆°ng ·ª©ng (ho·∫∑c th·ª≠ request nh·ªè) r·ªìi hi·ªán danh s√°ch model d√πng ƒë∆∞·ª£c

Gemini: g·ªçi list models (ho·∫∑c th·ª≠ request nh·ªè) r·ªìi hi·ªán c√°c model kh·∫£ d·ª•ng

B·∫°n ch·ªâ c·∫ßn n√≥i b·∫°n ƒëang d√πng Gemini theo h∆∞·ªõng n√†o: Gemini API (AI Studio key) hay Vertex AI (Google Cloud), v√¨ model-id/endpoint c·ªßa 2 lo·∫°i n√†y kh√°c nhau.


B·∫°n ƒë√£ n√≥i:
to√†n b·ªô m√£ htlm

ChatGPT ƒë√£ n√≥i:
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IELTS Speaking Pro - AI Powered</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    .recording-pulse { animation: pulse-red 2s infinite; }
    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    .mic-button { transition: all 0.3s ease; }
    .mic-button:active { transform: scale(0.95); }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4f46e5',
            secondary: '#10b981',
            accent: '#f59e0b',
          }
        }
      }
    }
  </script>
</head>

<body class="h-screen flex flex-col overflow-hidden">

  <!-- Navbar -->
  <nav class="bg-white border-b border-gray-200 shadow-sm z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <div class="flex-shrink-0 flex items-center gap-2 cursor-pointer" onclick="app.goHome()">
            <i class="fa-solid fa-microphone-lines text-primary text-2xl"></i>
            <span class="font-bold text-xl text-gray-800 tracking-tight">IELTS Speaking Pro</span>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <button onclick="app.toggleSettings()" class="flex items-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 hover:text-primary hover:border-primary transition shadow-sm">
            <i class="fa-solid fa-gear"></i>
            <span>C·∫•u h√¨nh AI</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto p-6 relative" id="main-container">

    <!-- View: Topic Grid (Home) -->
    <div id="topic-view" class="max-w-7xl mx-auto animate-fade-in">
      <div class="text-center mb-10">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">Ch·ªçn ch·ªß ƒë·ªÅ luy·ªán t·∫≠p</h1>
        <p class="text-lg text-gray-600">Luy·ªán n√≥i v√† nh·∫≠n ƒë√°nh gi√° AI ngay l·∫≠p t·ª©c.</p>
      </div>

      <!-- Search/Filter -->
      <div class="max-w-xl mx-auto mb-8 relative">
        <input type="text" id="search-input" placeholder="T√¨m ki·∫øm ch·ªß ƒë·ªÅ (Hobbies, Work, Health...)"
          class="w-full pl-12 pr-4 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary shadow-sm">
        <i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-400"></i>
      </div>

      <!-- Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="topic-grid"></div>
    </div>

    <!-- View: Practice Interface -->
    <div id="practice-view" class="hidden max-w-7xl mx-auto h-full flex flex-col md:flex-row gap-6">
      <!-- Left Sidebar: Questions -->
      <div class="w-full md:w-1/3 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col overflow-hidden h-[600px] md:h-auto">
        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
          <h2 class="font-bold text-gray-800" id="current-topic-title">Topic Name</h2>
          <button onclick="app.goHome()" class="text-sm text-gray-500 hover:text-primary">
            <i class="fa-solid fa-arrow-left"></i> Quay l·∫°i
          </button>
        </div>
        <div class="p-4 overflow-y-auto flex-1" id="question-list"></div>
      </div>

      <!-- Right Area: Recording & AI -->
      <div class="w-full md:w-2/3 flex flex-col gap-6">

        <!-- Recording Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex-1 flex flex-col">
          <div class="mb-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-1">C√¢u h·ªèi ƒëang ch·ªçn:</h3>
            <p class="text-primary text-xl font-medium" id="active-question-text">H√£y ch·ªçn m·ªôt c√¢u h·ªèi b√™n tr√°i</p>
          </div>

          <!-- Transcript Area -->
          <textarea id="transcript-area"
            class="w-full flex-1 p-4 bg-gray-50 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary mb-4 resize-none font-medium text-gray-700"
            placeholder="N·ªôi dung b√†i n√≥i c·ªßa b·∫°n s·∫Ω hi·ªán ·ªü ƒë√¢y (ho·∫∑c g√µ tr·ª±c ti·∫øp)..." spellcheck="false"></textarea>

          <!-- Controls -->
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <button id="btn-record" onclick="app.toggleRecording()"
                class="mic-button group flex items-center justify-center w-14 h-14 rounded-full bg-red-100 text-red-600 hover:bg-red-600 hover:text-white border-2 border-red-500">
                <i class="fa-solid fa-microphone text-xl"></i>
              </button>
              <span class="text-sm text-gray-500" id="record-status">Nh·∫•n ƒë·ªÉ n√≥i</span>
            </div>

            <div class="flex gap-3">
              <button onclick="app.clearTranscript()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">X√≥a</button>
              <button onclick="app.analyzeSpeaking()"
                class="px-6 py-2 bg-gradient-to-r from-primary to-indigo-600 text-white rounded-lg shadow hover:shadow-lg transition flex items-center gap-2">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Ch·∫•m ƒëi·ªÉm AI
              </button>
            </div>
          </div>
        </div>

        <!-- AI Feedback Section -->
        <div id="ai-result" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hidden">
          <div class="flex items-center justify-between mb-4 border-b border-gray-100 pb-2">
            <h3 class="text-lg font-bold text-gray-800">
              <i class="fa-solid fa-robot text-accent mr-2"></i>ƒê√°nh gi√° c·ªßa AI
            </h3>
            <div class="flex items-center gap-2">
              <span id="ai-provider-badge" class="bg-gray-100 text-gray-800 text-xs font-semibold px-2.5 py-0.5 rounded">AI</span>
              <span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded">IELTS Part 1</span>
            </div>
          </div>
          <div id="ai-content" class="prose prose-sm max-w-none text-gray-700"></div>
        </div>

      </div>
    </div>
  </main>

  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">C√†i ƒë·∫∑t AI</h3>
        <button onclick="app.toggleSettings()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
      </div>

      <!-- Provider -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Nh√† cung c·∫•p AI</label>
        <select id="ai-provider-select" class="w-full border border-gray-300 rounded-lg px-3 py-2" onchange="app.onProviderChange()">
          <option value="openai">OpenAI (ChatGPT)</option>
          <option value="gemini">Google Gemini</option>
        </select>
        <p class="text-xs text-gray-500 mt-1">
          Ch·ªçn nh√† cung c·∫•p ƒë·ªÉ g·ªçi ƒë√∫ng API. (T√™n hi·ªÉn th·ªã c√≥ th·ªÉ kh√°c model-id API th·∫≠t.)
        </p>
      </div>

      <!-- Key -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
        <input type="password" id="api-key-input" placeholder="sk-... ho·∫∑c AIza..."
          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:outline-none">
        <p class="text-xs text-gray-500 mt-1">Key c·ªßa b·∫°n ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô tr√™n tr√¨nh duy·ªát.</p>
      </div>

      <!-- Models -->
      <div class="mb-2">
        <label class="block text-sm font-medium text-gray-700 mb-2">M√¥ h√¨nh AI</label>

        <!-- OpenAI models -->
        <select id="openai-model-select" class="w-full border border-gray-300 rounded-lg px-3 py-2">
          <option value="gpt-5.2">GPT-5.2 (Base)</option>
          <option value="gpt-5.2-thinking">GPT-5.2 Thinking</option>
          <option value="gpt-5.2-pro">GPT-5.2 Pro</option>
          <option value="gpt-4o">GPT-4o</option>
          <option value="gpt-4o-mini">GPT-4o mini</option>
        </select>

        <!-- Gemini models -->
        <select id="gemini-model-select" class="w-full border border-gray-300 rounded-lg px-3 py-2 hidden">
          <!-- C√°c id d∆∞·ªõi ƒë√¢y l√† "best effort". N·∫øu key b·∫°n b√°o 404, ƒë·ªïi id theo ƒë√∫ng danh s√°ch model b·∫°n ƒë∆∞·ª£c c·∫•p. -->
          <option value="gemini-3-pro">Gemini 3 Pro</option>
          <option value="gemini-3-flash">Gemini 3 Flash</option>
          <option value="gemini-1.5-pro">Gemini 1.5 Pro (fallback)</option>
          <option value="gemini-1.5-flash">Gemini 1.5 Flash (fallback)</option>
        </select>

        <p class="text-xs text-amber-700 mt-2">
          N·∫øu Gemini b√°o ‚Äúmodel not found‚Äù: do model-id kh√¥ng ƒë√∫ng v·ªõi key c·ªßa b·∫°n ho·∫∑c b·∫°n ƒëang d√πng Vertex AI (endpoint kh√°c).
        </p>
      </div>

      <button onclick="app.saveSettings()" class="w-full bg-primary text-white rounded-lg py-2 font-medium hover:bg-indigo-700">
        L∆∞u c√†i ƒë·∫∑t
      </button>
    </div>
  </div>

  <script>
    // DATA SOURCE
    const topicsData = [
      { id: "hobbies", title: "Hobbies", icon: "fa-gamepad", color: "bg-pink-100 text-pink-600",
        questions: ["Do you have the same hobbies as your family members?","Do you have a hobby that you've had since childhood?","Did you have any hobbies when you were a child?","Do you have any hobbies?"] },
      { id: "scenery", title: "Scenery", icon: "fa-mountain-sun", color: "bg-green-100 text-green-600",
        questions: ["Where can you enjoy beautiful views where you live?","What‚Äôs the best view that you have ever enjoyed?","Do you take photos of good views?","Do you book rooms that have good views when you go travelling?","Do you look out the window at the scenery when travelling by bus or car?","Do you prefer the mountains or the sea?"] },
      { id: "health", title: "Health", icon: "fa-heart-pulse", color: "bg-red-100 text-red-600",
        questions: ["How do you keep healthy?","What are your favorite sports?","Are there health classes in your school?","What sports help people stay healthy?","Is it easy for people to exercise in your country?","Did you learn how to live a healthy lifestyle when you were a child?"] },
      { id: "work_study", title: "Work or Studies", icon: "fa-briefcase", color: "bg-blue-100 text-blue-600",
        questions: ["Are you a student or do you work now?","What would you like to do in the future?","What do you think is the most important at the moment?","Why did you choose to do that type of work?","Do you like your job?","Do you prefer to work in the morning or the afternoon?"] },
      { id: "photos", title: "Taking Photos", icon: "fa-camera", color: "bg-purple-100 text-purple-600",
        questions: ["Do you take photos by camera or phone?","How do you deal with pictures after you take them?","Do you want to learn photography to improve your taking-photo skills?","Is it good to keep photos on a cell phone?","Do you like taking photos of yourself?"] },
      { id: "area", title: "The area you live in", icon: "fa-map-location-dot", color: "bg-yellow-100 text-yellow-600",
        questions: ["Do you like the area that you live in?","Where do you like to go in that area?","Do you know any of your neighbors?","Are there any things you don't like about your area?","Do you like living in the countryside?"] },
      { id: "morning", title: "Morning Time", icon: "fa-sun", color: "bg-orange-100 text-orange-600",
        questions: ["Do you get up early in the morning?","Do you have the same morning routine every day?","Do you usually eat breakfast at home?","What do you usually do in the morning?"] },
      { id: "gifts", title: "Gifts", icon: "fa-gift", color: "bg-rose-100 text-rose-600",
        questions: ["Have you ever sent handmade gifts to others?","How to choose a gift?","Do you like giving gifts/presents?","When do you usually give gifts to others?","What gift have you received recently?"] },
      { id: "reading", title: "Reading", icon: "fa-book-open", color: "bg-indigo-100 text-indigo-600",
        questions: ["Which do you prefer, reading books or watching movies?","Are your reading habits now different than before?","Do you often read books? When?","Do you prefer to read on paper or on a screen?"] },
      { id: "pets", title: "Pets", icon: "fa-paw", color: "bg-stone-100 text-stone-600",
        questions: ["Do you keep a pet?","Did you have any pets when you were a child?","What's your favorite animal? Why?","Where do you prefer to keep your pet, indoors or outdoors?"] },
      { id: "typing", title: "Typing", icon: "fa-keyboard", color: "bg-gray-100 text-gray-600",
        questions: ["Do you prefer typing or handwriting?","Do you type on a desktop or laptop keyboard every day?","When did you learn how to type on a keyboard?","How do you improve your typing?"] },
      { id: "arts", title: "Arts and Drawing", icon: "fa-palette", color: "bg-teal-100 text-teal-600",
        questions: ["Do you like art?","Do you like visiting art galleries?","Do you like drawing? Why?","Did you learn to draw or paint when you were younger?"] }
    ];

    const app = {
      currentTopic: null,
      currentQuestion: null,
      isRecording: false,
      recognition: null,

      // Settings
      provider: localStorage.getItem('ai_provider') || 'openai',
      apiKey: localStorage.getItem('ai_key') || '',
      openaiModel: localStorage.getItem('openai_model') || 'gpt-4o-mini',
      geminiModel: localStorage.getItem('gemini_model') || 'gemini-1.5-flash',

      init() {
        this.renderTopics(topicsData);
        this.setupSpeechRecognition();

        // Load settings to UI
        document.getElementById('ai-provider-select').value = this.provider;
        document.getElementById('api-key-input').value = this.apiKey;
        document.getElementById('openai-model-select').value = this.openaiModel;
        document.getElementById('gemini-model-select').value = this.geminiModel;
        this.onProviderChange();

        // Search
        document.getElementById('search-input').addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase();
          const filtered = topicsData.filter(t => t.title.toLowerCase().includes(term));
          this.renderTopics(filtered);
        });
      },

      onProviderChange() {
        const provider = document.getElementById('ai-provider-select').value;
        const openaiSel = document.getElementById('openai-model-select');
        const geminiSel = document.getElementById('gemini-model-select');

        if (provider === 'openai') {
          openaiSel.classList.remove('hidden');
          geminiSel.classList.add('hidden');
        } else {
          geminiSel.classList.remove('hidden');
          openaiSel.classList.add('hidden');
        }
      },

      saveSettings() {
        const provider = document.getElementById('ai-provider-select').value;
        const key = document.getElementById('api-key-input').value.trim();
        const openaiModel = document.getElementById('openai-model-select').value;
        const geminiModel = document.getElementById('gemini-model-select').value;

        this.provider = provider;
        this.apiKey = key;
        this.openaiModel = openaiModel;
        this.geminiModel = geminiModel;

        localStorage.setItem('ai_provider', provider);
        localStorage.setItem('ai_key', key);
        localStorage.setItem('openai_model', openaiModel);
        localStorage.setItem('gemini_model', geminiModel);

        alert("ƒê√£ l∆∞u c√†i ƒë·∫∑t AI!");
        this.toggleSettings();
      },

      renderTopics(data) {
        const grid = document.getElementById('topic-grid');
        grid.innerHTML = data.map(topic => `
          <div onclick="app.openTopic('${topic.id}')"
            class="bg-white rounded-xl shadow hover:shadow-lg hover:-translate-y-1 transition-all duration-300 cursor-pointer overflow-hidden border border-gray-100 group">
            <div class="p-6">
              <div class="${topic.color} w-14 h-14 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                <i class="fa-solid ${topic.icon} text-2xl"></i>
              </div>
              <h3 class="text-xl font-bold text-gray-800 mb-2">${topic.title}</h3>
              <p class="text-sm text-gray-500">${topic.questions.length} Questions</p>
            </div>
            <div class="bg-gray-50 px-6 py-3 border-t border-gray-100 flex justify-between items-center">
              <span class="text-xs font-semibold text-primary">Luy·ªán t·∫≠p ngay</span>
              <i class="fa-solid fa-arrow-right text-gray-400 group-hover:text-primary transition"></i>
            </div>
          </div>
        `).join('');
      },

      openTopic(id) {
        this.currentTopic = topicsData.find(t => t.id === id);
        if (!this.currentTopic) return;

        document.getElementById('topic-view').classList.add('hidden');
        document.getElementById('practice-view').classList.remove('hidden');
        document.getElementById('practice-view').classList.add('flex');

        document.getElementById('current-topic-title').innerText = this.currentTopic.title;

        const list = document.getElementById('question-list');
        list.innerHTML = this.currentTopic.questions.map((q, index) => `
          <div onclick="app.selectQuestion(${index})"
            class="question-item p-3 mb-2 rounded-lg cursor-pointer transition hover:bg-indigo-50 border border-transparent hover:border-indigo-100 text-gray-700 text-sm">
            ${index + 1}. ${q}
          </div>
        `).join('');

        this.selectQuestion(0);
        this.clearTranscript();
        document.getElementById('ai-result').classList.add('hidden');
      },

      selectQuestion(index) {
        const items = document.querySelectorAll('.question-item');
        items.forEach(el => el.classList.remove('bg-indigo-100','border-indigo-200','font-medium','text-primary'));
        if (items[index]) items[index].classList.add('bg-indigo-100','border-indigo-200','font-medium','text-primary');

        this.currentQuestion = this.currentTopic.questions[index];
        document.getElementById('active-question-text').innerText = this.currentQuestion;
      },

      goHome() {
        document.getElementById('practice-view').classList.add('hidden');
        document.getElementById('practice-view').classList.remove('flex');
        document.getElementById('topic-view').classList.remove('hidden');
        this.stopRecording();
      },

      setupSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          this.recognition = new SpeechRecognition();
          this.recognition.continuous = true;
          this.recognition.interimResults = true;
          this.recognition.lang = 'en-US';

          this.recognition.onresult = (event) => {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
              if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
            }
            if (finalTranscript) {
              const area = document.getElementById('transcript-area');
              area.value += (area.value ? ' ' : '') + finalTranscript;
              area.scrollTop = area.scrollHeight;
            }
          };

          this.recognition.onerror = (event) => {
            console.error('Speech error:', event.error);
            this.stopRecording();
          };
        } else {
          alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i. H√£y d√πng Google Chrome.");
          document.getElementById('btn-record').disabled = true;
        }
      },

      toggleRecording() { this.isRecording ? this.stopRecording() : this.startRecording(); },

      startRecording() {
        if (!this.recognition) return;
        this.isRecording = true;
        this.recognition.start();

        const btn = document.getElementById('btn-record');
        btn.classList.add('recording-pulse','bg-red-600','text-white');
        document.getElementById('record-status').innerText = "ƒêang ghi √¢m...";
      },

      stopRecording() {
        if (!this.recognition) return;
        this.isRecording = false;
        this.recognition.stop();

        const btn = document.getElementById('btn-record');
        btn.classList.remove('recording-pulse','bg-red-600','text-white');
        document.getElementById('record-status').innerText = "Nh·∫•n ƒë·ªÉ n√≥i";
      },

      clearTranscript() {
        document.getElementById('transcript-area').value = '';
        document.getElementById('ai-result').classList.add('hidden');
      },

      toggleSettings() {
        const modal = document.getElementById('settings-modal');
        if (modal.classList.contains('hidden')) {
          modal.classList.remove('hidden'); modal.classList.add('flex');
        } else {
          modal.classList.add('hidden'); modal.classList.remove('flex');
        }
      },

      buildPrompt(transcript) {
        return `
Act as an IELTS Speaking Examiner.

Topic: ${this.currentTopic?.title || "Unknown"}
Question: "${this.currentQuestion || "Unknown"}"
Student Answer: "${transcript}"

Please provide feedback in Vietnamese:
1. Estimated Band Score (0-9)
2. Corrections for Grammar & Vocabulary errors (show original -> corrected)
3. Better version of the answer (paraphrase, natural, band 7+)
4. 5 vocabulary upgrades + collocations relevant to the topic
Format with Markdown.
`.trim();
      },

      setProviderBadge() {
        const badge = document.getElementById('ai-provider-badge');
        if (this.provider === 'gemini') badge.textContent = `Gemini ‚Ä¢ ${this.geminiModel}`;
        else badge.textContent = `ChatGPT ‚Ä¢ ${this.openaiModel}`;
      },

      // ===== OpenAI =====
      async callOpenAI(prompt) {
        const model = this.openaiModel;

        const resp = await fetch('https://api.openai.com/v1/responses', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.apiKey}`
          },
          body: JSON.stringify({
            model,
            input: prompt,
            temperature: 0.7
          })
        });

        const data = await resp.json();
        if (!resp.ok) {
          const msg = data?.error?.message || `OpenAI error (${resp.status})`;
          throw new Error(msg);
        }

        const text = data.output_text || '';
        if (!text) throw new Error("OpenAI tr·∫£ v·ªÅ r·ªóng.");
        return text;
      },

      // ===== Gemini (Google AI Studio key) =====
      getGeminiModelId() {
        // UI value -> API model id (best effort)
        const v = this.geminiModel;
        if (v === 'gemini-3-pro') return 'gemini-3-pro';
        if (v === 'gemini-3-flash') return 'gemini-3-flash';
        if (v === 'gemini-1.5-pro') return 'gemini-1.5-pro';
        if (v === 'gemini-1.5-flash') return 'gemini-1.5-flash';
        return 'gemini-1.5-flash';
      },

      async callGemini(prompt) {
        const modelId = this.getGeminiModelId();

        const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(modelId)}:generateContent?key=${encodeURIComponent(this.apiKey)}`;

        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.7 }
          })
        });

        const data = await resp.json();
        if (!resp.ok) {
          const msg = data?.error?.message || `Gemini error (${resp.status})`;
          throw new Error(msg);
        }

        const text = data?.candidates?.[0]?.content?.parts?.map(p => p.text).join('') || '';
        if (!text) throw new Error("Gemini tr·∫£ v·ªÅ r·ªóng.");
        return text;
      },

      async analyzeSpeaking() {
        const transcript = document.getElementById('transcript-area').value;
        const aiBox = document.getElementById('ai-result');
        const aiContent = document.getElementById('ai-content');

        if (!transcript.trim()) {
          alert("Vui l√≤ng ghi √¢m ho·∫∑c nh·∫≠p c√¢u tr·∫£ l·ªùi tr∆∞·ªõc khi ch·∫•m ƒëi·ªÉm.");
          return;
        }

        // update current settings from UI (in case user didn't click Save)
        this.provider = document.getElementById('ai-provider-select').value;
        this.apiKey = document.getElementById('api-key-input').value.trim();
        this.openaiModel = document.getElementById('openai-model-select').value;
        this.geminiModel = document.getElementById('gemini-model-select').value;
        this.setProviderBadge();

        aiBox.classList.remove('hidden');
        aiContent.innerHTML = '<div class="flex items-center gap-2"><i class="fa-solid fa-spinner fa-spin"></i> ƒêang ph√¢n t√≠ch c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n...</div>';

        // Demo if no key
        if (!this.apiKey) {
          setTimeout(() => {
            const mockResponse = `
**L∆∞u √Ω:** ƒê√¢y l√† k·∫øt qu·∫£ m√¥ ph·ªèng v√¨ ch∆∞a c√≥ API Key.

### ƒêi·ªÉm ∆∞·ªõc l∆∞·ª£ng: 6.5

**Grammar**
- C√¢u kh√° r√µ √Ω, nh∆∞ng n√™n tƒÉng c√¢u ph·ª©c.
- G·ª£i √Ω: th√™m "However / Moreover / As a result".

**Vocabulary**
- T·ª´ v·ª±ng ·ªïn theo ch·ªß ƒë·ªÅ **${this.currentTopic?.title || ""}**.
- G·ª£i √Ω n√¢ng cao: thay **"good"** ‚Üí **"impressive / remarkable"**.

**Pronunciation**
- Ch√∫ √Ω ending sounds v√† nh·∫•n tr·ªçng √¢m t·ª´ kh√≥a.
`;
            aiContent.innerHTML = marked.parse(mockResponse);
            alert("H√£y nh·∫≠p API Key trong C√†i ƒë·∫∑t ƒë·ªÉ d√πng AI th·∫≠t.");
          }, 700);
          return;
        }

        try {
          const prompt = this.buildPrompt(transcript);
          let outputText = '';

          if (this.provider === 'gemini') outputText = await this.callGemini(prompt);
          else outputText = await this.callOpenAI(prompt);

          aiContent.innerHTML = marked.parse(outputText);
        } catch (error) {
          aiContent.innerHTML = `
            <div class="text-red-600 font-semibold">L·ªói AI: ${String(error.message || error)}</div>
            <div class="text-xs text-gray-600 mt-2">
              G·ª£i √Ω:
              <ul class="list-disc ml-5 mt-1">
                <li>Ch·ªçn ƒë√∫ng <b>Nh√† cung c·∫•p</b> (OpenAI/Gemini)</li>
                <li>Model c√≥ th·ªÉ <b>kh√¥ng ƒë∆∞·ª£c c·∫•p</b> cho key c·ªßa b·∫°n ‚Üí th·ª≠ fallback (Gemini 1.5 Flash/Pro ho·∫∑c GPT-4o-mini)</li>
                <li>N·∫øu b·∫°n d√πng <b>Vertex AI</b> th√¨ endpoint Gemini kh√°c (kh√¥ng d√πng generativelanguage.googleapis.com)</li>
              </ul>
            </div>
          `;
        }
      }
    };

    window.onload = () => app.init();
  </script>
</body>
</html>



Ti·ªán √≠ch - Hanzii

<
[ < ]
1. <

Xem chi ti·∫øt
