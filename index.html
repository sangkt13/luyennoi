<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IELTS Speaking Pro - AI Powered</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .recording-pulse { animation: pulse-red 2s infinite; }
    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    .mic-button { transition: all 0.25s ease; }
    .mic-button:active { transform: scale(0.96); }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: '#4f46e5', secondary: '#10b981', accent: '#f59e0b' }
        }
      }
    };
  </script>
</head>

<body class="h-screen flex flex-col overflow-hidden">
  <!-- Navbar -->
  <nav class="bg-white border-b border-gray-200 shadow-sm z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <div class="flex-shrink-0 flex items-center gap-2 cursor-pointer" onclick="app.goHome()">
            <i class="fa-solid fa-microphone-lines text-primary text-2xl"></i>
            <span class="font-bold text-xl text-gray-800 tracking-tight">IELTS Speaking Pro</span>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <button onclick="app.toggleSettings()"
            class="flex items-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 hover:text-primary hover:border-primary transition shadow-sm">
            <i class="fa-solid fa-gear"></i>
            <span>Cấu hình AI</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main id="main-container" class="flex-1 relative overflow-hidden">
    <!-- View: Topic Grid -->
    <div id="topic-view" class="absolute inset-0 overflow-y-auto p-6">
      <div class="max-w-7xl mx-auto">
        <div class="text-center mb-10">
          <h1 class="text-4xl font-bold text-gray-900 mb-4">Chọn chủ đề luyện tập</h1>
          <p class="text-lg text-gray-600">Luyện nói và nhận đánh giá AI ngay lập tức.</p>
        </div>

        <div class="max-w-xl mx-auto mb-8 relative">
          <input type="text" id="search-input" placeholder="Tìm kiếm chủ đề (Hobbies, Work, Health...)"
            class="w-full pl-12 pr-4 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary shadow-sm" />
          <i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-400"></i>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="topic-grid"></div>
      </div>
    </div>

    <!-- View: Practice -->
    <div id="practice-view" class="absolute inset-0 overflow-y-auto p-6 hidden">
      <div class="max-w-7xl mx-auto h-full flex flex-col md:flex-row gap-6">
        <!-- Left Sidebar -->
        <div class="w-full md:w-1/3 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col overflow-hidden md:h-[calc(100vh-160px)]">
          <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <h2 class="font-bold text-gray-800" id="current-topic-title">Topic</h2>
            <button onclick="app.goHome()" class="text-sm text-gray-500 hover:text-primary">
              <i class="fa-solid fa-arrow-left"></i> Quay lại
            </button>
          </div>
          <div class="p-4 overflow-y-auto flex-1" id="question-list"></div>
        </div>

        <!-- Right Area -->
        <div class="w-full md:w-2/3 flex flex-col gap-6">
          <!-- Recording -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex-1 flex flex-col md:min-h-[calc(100vh-360px)]">
            <div class="mb-4">
              <h3 class="text-lg font-semibold text-gray-800 mb-1">Câu hỏi đang chọn:</h3>
              <p class="text-primary text-xl font-medium" id="active-question-text">Hãy chọn một câu hỏi bên trái</p>
            </div>

            <textarea id="transcript-area"
              class="w-full flex-1 min-h-[180px] p-4 bg-gray-50 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary mb-4 resize-none font-medium text-gray-700"
              placeholder="Nội dung bài nói của bạn sẽ hiện ở đây (hoặc gõ trực tiếp)..."
              spellcheck="false"></textarea>

            <div class="flex items-center justify-between flex-wrap gap-3">
              <div class="flex items-center gap-2">
                <button id="btn-record" onclick="app.toggleRecording()"
                  class="mic-button group flex items-center justify-center w-14 h-14 rounded-full bg-red-100 text-red-600 hover:bg-red-600 hover:text-white border-2 border-red-500">
                  <i class="fa-solid fa-microphone text-xl"></i>
                </button>
                <span class="text-sm text-gray-500" id="record-status">Nhấn để nói</span>
              </div>

              <div class="flex gap-3 flex-wrap">
                <button onclick="app.clearTranscript()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">
                  Xóa
                </button>

                <button onclick="app.fixTranscriptByAI()" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:border-primary hover:text-primary transition flex items-center gap-2">
                  <i class="fa-solid fa-spell-check"></i> Sửa transcript
                </button>

                <button onclick="app.analyzeSpeaking()"
                  class="px-6 py-2 bg-gradient-to-r from-primary to-indigo-600 text-white rounded-lg shadow hover:shadow-lg transition flex items-center gap-2">
                  <i class="fa-solid fa-wand-magic-sparkles"></i> Chấm điểm AI
                </button>
              </div>
            </div>
          </div>

          <!-- AI Result -->
          <div id="ai-result" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hidden">
            <div class="flex items-center justify-between mb-4 border-b border-gray-100 pb-2">
              <h3 class="text-lg font-bold text-gray-800">
                <i class="fa-solid fa-robot text-accent mr-2"></i>Đánh giá của AI
              </h3>
              <span id="ai-badge" class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded">
                IELTS Part 1
              </span>
            </div>
            <div id="ai-content" class="prose prose-sm max-w-none text-gray-700"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Cài đặt AI</h3>
        <button onclick="app.toggleSettings()" class="text-gray-400 hover:text-gray-600">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Nhà cung cấp (Provider)</label>
        <select id="ai-provider-select" class="w-full border border-gray-300 rounded-lg px-3 py-2">
          <option value="openai">OpenAI</option>
          <option value="gemini">Gemini</option>
        </select>
        <p class="text-xs text-gray-500 mt-1">Nếu deploy public: nên dùng serverless để không lộ key.</p>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
        <input type="password" id="api-key-input" placeholder="sk-... hoặc Gemini key..."
          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:outline-none" />
        <p class="text-xs text-gray-500 mt-1">Key được lưu cục bộ trên trình duyệt (localStorage).</p>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Mô hình</label>
        <select id="ai-model-select" class="w-full border border-gray-300 rounded-lg px-3 py-2"></select>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Giọng/Accent để nhận dạng (Speech)</label>
        <select id="speech-lang-select" class="w-full border border-gray-300 rounded-lg px-3 py-2">
          <option value="en-US">English (US)</option>
          <option value="en-GB">English (UK)</option>
          <option value="en-AU">English (AU)</option>
          <option value="en-IN">English (IN)</option>
          <option value="vi-VN">Vietnamese (vi-VN)</option>
        </select>
        <p class="text-xs text-gray-500 mt-1">Chọn đúng accent sẽ giảm nghe sai từ.</p>
      </div>

      <button onclick="app.saveSettings()" class="w-full bg-primary text-white rounded-lg py-2 font-medium hover:bg-indigo-700">
        Lưu cài đặt
      </button>
    </div>
  </div>

  <script>
    // ===== DATA SOURCE (Part 1 + Hard topics) =====
    const topicsData = [
      {
        id: "health",
        title: "Health",
        icon: "fa-heart-pulse",
        color: "bg-red-100 text-red-600",
        questions: [
          "How do you keep healthy?",
          "What are your favorite sports?",
          "Are there health classes in your school?",
          "What sports help people stay healthy?",
          "Is it easy for people to exercise in your country?",
          "Did you learn how to live a healthy lifestyle when you were a child?"
        ]
      },
      {
        id: "technology",
        title: "Technology & Apps",
        icon: "fa-mobile-screen-button",
        color: "bg-indigo-100 text-indigo-600",
        questions: [
          "What app do you use the most and why?",
          "Do you think technology makes life easier or more stressful?",
          "How often do you update your phone or laptop?",
          "Do you prefer learning online or offline?",
          "What are the disadvantages of using social media too much?",
          "Do you think AI will change education in the future?"
        ]
      },
      {
        id: "worklife",
        title: "Work–Life Balance",
        icon: "fa-scale-balanced",
        color: "bg-blue-100 text-blue-600",
        questions: [
          "How do you balance work and rest?",
          "Do you often feel stressed because of work or study?",
          "What do you usually do to relax after a busy day?",
          "Do you think people should work fewer hours?",
          "What makes a job satisfying?",
          "Do you think working from home is a good idea?"
        ]
      },
      {
        id: "environment",
        title: "Environment (Hard)",
        icon: "fa-leaf",
        color: "bg-green-100 text-green-700",
        questions: [
          "What are the biggest environmental problems in your city?",
          "Do you think individuals can really help the environment?",
          "Should governments punish people who pollute?",
          "What can schools do to teach environmental awareness?",
          "Is recycling common in your country?",
          "Do you think climate change will affect your future?"
        ]
      },
      {
        id: "education",
        title: "Education & Exams (Hard)",
        icon: "fa-graduation-cap",
        color: "bg-yellow-100 text-yellow-700",
        questions: [
          "Do exams measure real ability?",
          "Should students learn more practical skills at school?",
          "What makes a good teacher?",
          "Do you prefer group study or self-study?",
          "How can students improve their speaking skills?",
          "Should universities use AI tools in teaching?"
        ]
      },
      {
        id: "socialmedia",
        title: "Social Media & Privacy (Hard)",
        icon: "fa-shield-halved",
        color: "bg-rose-100 text-rose-700",
        questions: [
          "Do you think social media is good for communication?",
          "What are the risks of sharing too much online?",
          "Should governments control social media content?",
          "How can people protect their privacy online?",
          "Do you trust online news?",
          "Do you think social media affects mental health?"
        ]
      },
      {
        id: "hobbies",
        title: "Hobbies",
        icon: "fa-gamepad",
        color: "bg-pink-100 text-pink-600",
        questions: [
          "Do you have the same hobbies as your family members?",
          "Do you have a hobby that you've had since childhood?",
          "Did you have any hobbies when you were a child?",
          "Do you have any hobbies?",
          "What hobby would you like to try in the future?",
          "Do you prefer indoor or outdoor hobbies?"
        ]
      },
      {
        id: "scenery",
        title: "Scenery",
        icon: "fa-mountain-sun",
        color: "bg-emerald-100 text-emerald-700",
        questions: [
          "Where can you enjoy beautiful views where you live?",
          "What’s the best view that you have ever enjoyed?",
          "Do you take photos of good views?",
          "Do you book rooms that have good views when you go travelling?",
          "Do you look out the window at the scenery when travelling by bus or car?",
          "Do you prefer the mountains or the sea?"
        ]
      },
      {
        id: "morning",
        title: "Morning Time",
        icon: "fa-sun",
        color: "bg-orange-100 text-orange-600",
        questions: [
          "Do you get up early in the morning?",
          "Do you have the same morning routine every day?",
          "Do you usually eat breakfast at home?",
          "What do you usually do in the morning?",
          "Do you think mornings are productive for you?",
          "What is the best way to start a day?"
        ]
      },
      {
        id: "reading",
        title: "Reading",
        icon: "fa-book-open",
        color: "bg-violet-100 text-violet-700",
        questions: [
          "Which do you prefer, reading books or watching movies?",
          "Are your reading habits now different than before?",
          "Do you often read books? When?",
          "Do you prefer to read on paper or on a screen?",
          "What kind of books do you like?",
          "Do you think reading is important today?"
        ]
      }
    ];

    // Model presets
    const MODELS = {
      openai: [
        { value: "gpt-4o-mini", label: "gpt-4o-mini (Nhanh/giá rẻ)" },
        { value: "gpt-4o", label: "gpt-4o (Chính xác)" },
        { value: "gpt-3.5-turbo", label: "gpt-3.5-turbo (Cũ)" }
      ],
      gemini: [
        { value: "gemini-1.5-flash", label: "gemini-1.5-flash (Nhanh)" },
        { value: "gemini-1.5-pro", label: "gemini-1.5-pro (Mạnh)" }
      ]
    };

    // ===== APP =====
    const app = {
      currentTopic: null,
      currentQuestion: null,
      isRecording: false,
      recognition: null,

      settings: {
        provider: localStorage.getItem('ai_provider') || 'openai',
        apiKey: localStorage.getItem('ai_key') || '',
        model: localStorage.getItem('ai_model') || '',
        speechLang: localStorage.getItem('speech_lang') || 'en-US',
      },

      init() {
        this.renderTopics(topicsData);
        this.setupSpeechRecognition();
        this.showView('topic');

        // search
        document.getElementById('search-input').addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase();
          const filtered = topicsData.filter(t => t.title.toLowerCase().includes(term));
          this.renderTopics(filtered);
        });

        // settings init
        const providerSel = document.getElementById('ai-provider-select');
        const keyInput = document.getElementById('api-key-input');
        const speechSel = document.getElementById('speech-lang-select');

        providerSel.value = this.settings.provider;
        keyInput.value = this.settings.apiKey;
        speechSel.value = this.settings.speechLang;

        providerSel.addEventListener('change', () => {
          this.settings.provider = providerSel.value;
          this.populateModelSelect();
        });

        speechSel.addEventListener('change', (e) => {
          this.settings.speechLang = e.target.value;
          localStorage.setItem('speech_lang', this.settings.speechLang);
          if (this.recognition) this.recognition.lang = this.settings.speechLang;
        });

        this.populateModelSelect();
      },

      showView(name) {
        const tv = document.getElementById('topic-view');
        const pv = document.getElementById('practice-view');
        if (name === 'topic') {
          tv.classList.remove('hidden');
          pv.classList.add('hidden');
        } else {
          tv.classList.add('hidden');
          pv.classList.remove('hidden');
        }
        document.getElementById('main-container').scrollTop = 0;
      },

      populateModelSelect() {
        const modelSel = document.getElementById('ai-model-select');
        const provider = this.settings.provider;
        const list = MODELS[provider] || [];
        modelSel.innerHTML = list.map(m => `<option value="${m.value}">${m.label}</option>`).join('');

        const saved = localStorage.getItem('ai_model');
        const exists = list.some(m => m.value === saved);
        this.settings.model = exists ? saved : (list[0]?.value || '');
        modelSel.value = this.settings.model;

        modelSel.onchange = () => {
          this.settings.model = modelSel.value;
        };
      },

      renderTopics(data) {
        const grid = document.getElementById('topic-grid');
        grid.innerHTML = data.map(topic => `
          <div onclick="app.openTopic('${topic.id}')"
               class="bg-white rounded-xl shadow hover:shadow-lg hover:-translate-y-1 transition-all duration-300 cursor-pointer overflow-hidden border border-gray-100 group">
            <div class="p-6">
              <div class="${topic.color} w-14 h-14 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                <i class="fa-solid ${topic.icon} text-2xl"></i>
              </div>
              <h3 class="text-xl font-bold text-gray-800 mb-2">${topic.title}</h3>
              <p class="text-sm text-gray-500">${topic.questions.length} Questions</p>
            </div>
            <div class="bg-gray-50 px-6 py-3 border-t border-gray-100 flex justify-between items-center">
              <span class="text-xs font-semibold text-primary">Luyện tập ngay</span>
              <i class="fa-solid fa-arrow-right text-gray-400 group-hover:text-primary transition"></i>
            </div>
          </div>
        `).join('');
      },

      openTopic(id) {
        this.currentTopic = topicsData.find(t => t.id === id);
        if (!this.currentTopic) return;

        this.showView('practice');
        document.getElementById('current-topic-title').innerText = this.currentTopic.title;

        const list = document.getElementById('question-list');
        list.innerHTML = this.currentTopic.questions.map((q, index) => `
          <div onclick="app.selectQuestion(${index})"
               class="question-item p-3 mb-2 rounded-lg cursor-pointer transition hover:bg-indigo-50 border border-transparent hover:border-indigo-100 text-gray-700 text-sm">
            ${index + 1}. ${q}
          </div>
        `).join('');

        this.selectQuestion(0);
        this.clearTranscript();
      },

      selectQuestion(index) {
        const items = document.querySelectorAll('.question-item');
        items.forEach(el => el.classList.remove('bg-indigo-100', 'border-indigo-200', 'font-medium', 'text-primary'));
        if (items[index]) items[index].classList.add('bg-indigo-100', 'border-indigo-200', 'font-medium', 'text-primary');

        this.currentQuestion = this.currentTopic.questions[index];
        document.getElementById('active-question-text').innerText = this.currentQuestion;
      },

      goHome() {
        this.stopRecording();
        this.showView('topic');
      },

      setupSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          this.recognition = new SpeechRecognition();
          this.recognition.continuous = true;
          this.recognition.interimResults = true;
          this.recognition.lang = this.settings.speechLang || 'en-US';

          this.recognition.onresult = (event) => {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
              if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
            }
            if (finalTranscript) {
              const area = document.getElementById('transcript-area');
              area.value += (area.value ? ' ' : '') + finalTranscript;
              area.scrollTop = area.scrollHeight;
            }
          };

          this.recognition.onerror = (event) => {
            console.error('Speech error:', event.error);
            this.stopRecording();
          };
        } else {
          alert("Trình duyệt không hỗ trợ nhận diện giọng nói. Hãy dùng Google Chrome.");
          document.getElementById('btn-record').disabled = true;
        }
      },

      toggleRecording() { this.isRecording ? this.stopRecording() : this.startRecording(); },

      startRecording() {
        if (!this.recognition) return;
        this.isRecording = true;
        try { this.recognition.start(); } catch (_) {}

        const btn = document.getElementById('btn-record');
        btn.classList.add('recording-pulse', 'bg-red-600', 'text-white');
        document.getElementById('record-status').innerText = "Đang ghi âm...";
      },

      stopRecording() {
        if (!this.recognition) return;
        this.isRecording = false;
        try { this.recognition.stop(); } catch (_) {}

        const btn = document.getElementById('btn-record');
        btn.classList.remove('recording-pulse', 'bg-red-600', 'text-white');
        document.getElementById('record-status').innerText = "Nhấn để nói";
      },

      clearTranscript() {
        document.getElementById('transcript-area').value = '';
        document.getElementById('ai-result').classList.add('hidden');
      },

      toggleSettings() {
        const modal = document.getElementById('settings-modal');
        if (modal.classList.contains('hidden')) {
          modal.classList.remove('hidden'); modal.classList.add('flex');
        } else {
          modal.classList.add('hidden'); modal.classList.remove('flex');
        }
      },

      saveSettings() {
        const provider = document.getElementById('ai-provider-select').value;
        const key = document.getElementById('api-key-input').value.trim();
        const model = document.getElementById('ai-model-select').value;
        const speechLang = document.getElementById('speech-lang-select').value;

        this.settings.provider = provider;
        this.settings.apiKey = key;
        this.settings.model = model;
        this.settings.speechLang = speechLang;

        localStorage.setItem('ai_provider', provider);
        localStorage.setItem('ai_key', key);
        localStorage.setItem('ai_model', model);
        localStorage.setItem('speech_lang', speechLang);

        if (this.recognition) this.recognition.lang = speechLang;

        alert("Đã lưu cài đặt!");
        this.toggleSettings();
      },

      buildPrompt(transcript) {
        return `
Act as an IELTS Speaking Examiner.

Topic: ${this.currentTopic?.title || ""}
Question: "${this.currentQuestion || ""}"
Student Answer: "${transcript}"

Please provide feedback in Vietnamese with Markdown:
1) Estimated Band Score (0-9)
2) Corrections for Grammar & Vocabulary errors (list errors + correction)
3) Improved version of the answer (natural, band 6.0-7.0)
4) Pronunciation tips (ending sounds, word stress) based on typical Vietnamese accent
5) 5 useful phrases/collocations for this topic
`.trim();
      },

      async callAI(prompt, temperature = 0.7) {
        const provider = this.settings.provider;
        const apiKey = this.settings.apiKey;
        const model = this.settings.model || document.getElementById('ai-model-select').value;

        if (provider === 'openai') {
          const resp = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model,
              messages: [{ role: "user", content: prompt }],
              temperature
            })
          });
          const data = await resp.json();
          if (data.error) throw new Error(data.error.message || 'OpenAI API error');
          return data.choices?.[0]?.message?.content || "";
        }

        // Gemini
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent?key=${encodeURIComponent(apiKey)}`;
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: { temperature }
          })
        });
        const data = await resp.json();
        if (data.error) throw new Error(data.error.message || 'Gemini API error');
        return data.candidates?.[0]?.content?.parts?.map(p => p.text).join("\n") || "";
      },

      async fixTranscriptByAI() {
        const area = document.getElementById('transcript-area');
        const raw = area.value.trim();
        if (!raw) { alert("Chưa có transcript để sửa."); return; }
        if (!this.settings.apiKey) { alert("Bạn cần nhập API Key để dùng tính năng sửa transcript."); return; }

        const prompt = `
You are a speech-to-text correction assistant for Vietnamese learners speaking English.
The transcript below may contain wrong words due to accent recognition.
Task:
1) Produce a corrected English transcript that best matches what the speaker likely meant.
2) Keep it natural and simple (IELTS band 5-6).
3) Do NOT add new ideas. Just fix mistaken words and grammar lightly.
Return ONLY the corrected transcript text.

Transcript:
"""${raw}"""
`.trim();

        area.disabled = true;
        const old = area.value;
        area.value = "Đang sửa transcript bằng AI...";

        try {
          let out = await this.callAI(prompt, 0.2);
          out = (out || "").trim();
          if (!out) throw new Error("Không nhận được kết quả sửa transcript.");
          area.value = out;
        } catch (e) {
          area.value = old;
          alert("Lỗi sửa transcript: " + e.message);
        } finally {
          area.disabled = false;
        }
      },

      async analyzeSpeaking() {
        const transcript = document.getElementById('transcript-area').value;
        const aiBox = document.getElementById('ai-result');
        const aiContent = document.getElementById('ai-content');
        const badge = document.getElementById('ai-badge');

        if (!transcript.trim()) {
          alert("Vui lòng ghi âm hoặc nhập câu trả lời trước khi chấm điểm.");
          return;
        }

        aiBox.classList.remove('hidden');
        aiContent.innerHTML = '<div class="flex items-center gap-2"><i class="fa-solid fa-spinner fa-spin"></i> Đang phân tích câu trả lời...</div>';

        const provider = this.settings.provider;
        badge.textContent = provider === 'gemini' ? 'Gemini' : 'OpenAI';

        if (!this.settings.apiKey) {
          const mock = `
**Lưu ý:** Đây là kết quả mô phỏng vì chưa có API Key.

### Band ước lượng: 5.0 – 5.5
**Vấn đề chính:**
- Câu trả lời quá ngắn.
- Ngữ pháp chưa đúng.

**Gợi ý sửa nhanh:**
> *To be honest, I'm quite busy, so I don't exercise every day. However, I try to walk whenever I can and drink enough water.*

**Cụm từ nên dùng:**
- *to be honest*
- *I try to...*
- *whenever I can*
- *a balanced diet*
- *stay active*
`;
          aiContent.innerHTML = marked.parse(mock);
          alert("Bạn hãy nhập API Key trong Cấu hình AI để dùng AI thật.");
          return;
        }

        try {
          const prompt = this.buildPrompt(transcript);
          const out = await this.callAI(prompt, 0.7);
          aiContent.innerHTML = marked.parse(out || "Không có phản hồi.");
        } catch (err) {
          aiContent.innerHTML = `<div class="text-red-500">Lỗi kết nối AI: ${err.message}</div>`;
        }
      }
    };

    window.onload = () => app.init();
  </script>
</body>
</html>
